image: node:22-alpine
services:
  - docker:20.10.16-dind

variables:
  DOCKER_TLS_CERTDIR: "/certs"
  FRONTEND_IMAGE: $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA
  API_IMAGE: $CI_REGISTRY_IMAGE/api:$CI_COMMIT_SHA
  FF_USE_FASTZIP: "true"
  ARTIFACT_COMPRESSION_LEVEL: "fast"
  CACHE_COMPRESSION_LEVEL: "fast"

cache: &global_cache
  key: ${CI_COMMIT_REF_SLUG}
  when: on_success
  paths:
    - .npm/
    - .cache/pip/

stages:
  - lint
  - test
  - build
  - deploy

.frontend_rules: &frontend_rules
  rules:
    - changes:
        - frontend/**/*
        - .gitlab-ci.yml

.api_rules: &api_rules
  rules:
    - changes:
        - connect-four-api/**/*
        - .gitlab-ci.yml

frontend-lint:
  stage: lint
  image: node:22-alpine
  allow_failure: true
  cache:
    <<: *global_cache
    paths:
      - frontend/.npm/
  before_script:
    - cd frontend
    - npm ci --cache .npm --prefer-offline
  script:
    - npx eslint .
  <<: *frontend_rules

api-lint:
  stage: lint
  image: python:3.11-alpine
  allow_failure: true
  cache:
    <<: *global_cache
    paths:
      - .cache/pip/
  script:
    - cd connect-four-api
    - pip install --cache-dir=../.cache/pip ruff
    - ruff check .
  <<: *api_rules

api-test:
  stage: test
  image: python:3.11-slim
  cache:
    <<: *global_cache
    paths:
      - .cache/pip/
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends libgl1-mesa-glx libglib2.0-0 libsm6 libxext6 libxrender1
    - rm -rf /var/lib/apt/lists/*
    - cd connect-four-api
    - pip install --cache-dir=../.cache/pip --no-deps --upgrade -r requirements.txt
  script:
    - python -m pytest --cov=. --cov-report=term-missing
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: connect-four-api/coverage.xml
  <<: *api_rules

build-frontend:
  stage: build
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  variables:
    DOCKER_HOST: "tcp://docker:2375"
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - docker buildx create --use
  cache:
    <<: *global_cache
    paths:
      - frontend/.npm/
  script:
    - cd frontend
    - docker buildx build --cache-from=$CI_REGISTRY_IMAGE/frontend:latest --platform linux/amd64,linux/arm64 -t "$FRONTEND_IMAGE" --push .

build-api:
  stage: build
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  variables:
    DOCKER_HOST: "tcp://docker:2375"
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - docker buildx create --use
  script:
    - cd connect-four-api
    - docker buildx build --cache-from=$CI_REGISTRY_IMAGE/api:latest --cache-to=type=inline --platform linux/amd64,linux/arm64 -t "$API_IMAGE" --push .

deploy:
  stage: deploy
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  variables:
    DOCKER_HOST: "tcp://docker:2375"
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - docker buildx create --use
  script:
    - docker buildx imagetools create -t "$CI_REGISTRY_IMAGE/frontend:latest" "$FRONTEND_IMAGE"
    - docker buildx imagetools create -t "$CI_REGISTRY_IMAGE/api:latest" "$API_IMAGE"
  only:
    - main
